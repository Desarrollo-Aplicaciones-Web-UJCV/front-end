<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <link rel="shortcut icon" href="../../img/logo-icono.png">
    <title>Sistema de Ventas</title>

    <!-- Custom fonts for this template-->
    <link
      href="../../vendor/fontawesome-free/css/all.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
      rel="stylesheet"
    />
    <!-- Custom styles for this template-->
    <link href="../../css/sb-admin-2.min.css" rel="stylesheet" />
  </head>

  <body id="page-top">
    <!-- Page Wrapper -->
    <div id="wrapper">
      <!-- Sidebar -->
      <ul
        class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion"
        id="accordionSidebar"
      >
        <!-- Sidebar - Brand -->
        <a
          class="sidebar-brand d-flex align-items-center justify-content-center"
          href="../indexvendedor.html"
        >
          <div class="sidebar-brand-icon">
            <img src="../../img/logo-icono.png" />
            <!-- <i class="fas fa-user"></i> -->
          </div>
          <div class="sidebar-brand-text mx-3">Ferreteria Central</div>
        </a>

        <!-- Divider -->
        <hr class="sidebar-divider my-0" />

        <!-- Nav Item - Dashboard -->
        <li class="nav-item active">
          <a class="nav-link" href="../indexAdministrador.html">
            <i class="fas fa-fw fa-cogs"></i>
            <span>Panel de Administración</span></a
          >
        </li>

        <!-- Divider -->
        <hr class="sidebar-divider" />

        <!-- Heading -->
        <div class="sidebar-heading">Módulos</div>

        <!-- Nav Item - Pages Collapse Menu -->
        <li class="nav-item">
          <a class="nav-link collapsed" href="#">
            <img src="../../img/ventas1.png" />
            <!-- <i class="fas fa-fw fa-dollar-sign"></i> -->
            <span>Ventas</span>
          </a>
        </li>
        <li class="nav-item">
            <a class="nav-link collapsed" href="#">
              <img src="../../img/productos1.png" />
              <!-- <i class="fas fa-fw fa-dollar-sign"></i> -->
              <span>Productos</span>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link collapsed" href="#">
              <img src="../../img/clientes1.png" />
              <!-- <i class="fas fa-fw fa-dollar-sign"></i> -->
              <span>Clientes</span>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link collapsed" href="#">
              <img src="../../img/inventario1.png" />
              <!-- <i class="fas fa-fw fa-dollar-sign"></i> -->
              <span>Proveedores</span>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link collapsed" href="#">
              <img src="../../img/carrito-de-compras.png" />
              <!-- <i class="fas fa-fw fa-dollar-sign"></i> -->
              <span>Compras</span>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link collapsed" href="#">
              <img src="../../img/usuario (1).png" />
              <!-- <i class="fas fa-fw fa-dollar-sign"></i> -->
              <span>Usuarios</span>
            </a>
        </li>
        
         <!-- Divider -->
         <hr class="sidebar-divider">

         <!-- Sidebar Toggler (Sidebar) -->
         <div class="text-center d-none d-md-inline">
             <button class="rounded-circle border-0" id="sidebarToggle"></button>
         </div>

      </ul>
      <!-- End of Sidebar -->

      <!-- Content Wrapper -->
      <div id="content-wrapper" class="d-flex flex-column">
        <!-- Main Content -->
        <div id="content">
          <!-- Topbar -->
          <nav
            class="
              navbar navbar-expand navbar-light
              bg-gradient-primary
              topbar
              mb-4
              static-top
              shadow
            "
          >
            <!-- Sidebar Toggle (Topbar) -->
            <button
              id="sidebarToggleTop"
              class="btn btn-link d-md-none rounded-circle mr-3"
            >
              <i class="fa fa-bars"></i>
            </button>

            <!-- Topbar Navbar -->
            <ul class="navbar-nav ml-auto">
              <div class="topbar-divider d-none d-sm-block"></div>

              <!-- Nav Item - User Information -->
              <li class="nav-item dropdown no-arrow">
                <a
                  class="nav-link dropdown-toggle"
                  href="#"
                  id="userDropdown"
                  role="button"
                  data-toggle="dropdown"
                  aria-haspopup="true"
                  aria-expanded="false"
                >
                  <span class="mr-2 d-none d-lg-inline text-white-600 small"
                    >Eduin Flores</span
                  >
                  <img
                    class="img-profile rounded-circle"
                    src="../../img/undraw_profile.svg"
                  />
                </a>
                <!-- Dropdown - User Information -->
                <div
                  class="
                    dropdown-menu dropdown-menu-right
                    shadow
                    animated--grow-in
                  "
                  aria-labelledby="userDropdown"
                >
                  <a
                    class="dropdown-item"
                    href="#"
                    data-toggle="modal"
                    data-target="#logoutModal"
                  >
                    <i
                      class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"
                    ></i>
                    Cerrar Sesión
                  </a>
                </div>
              </li>
            </ul>
          </nav>
          <!-- End of Topbar -->

          <!-- Begin Page Content -->
          <div class="container-fluid">
            <div class="row">
            <div class="col-lg-12">
            <div class="form-group">
                <h4 class="text-center">Datos del Cliente</h4>
                <a href="../clientes/nuevoCliente.html" class="btn btn-primary btn_new_cliente"><i class="fas fa-user-plus"></i> Nuevo Cliente</a>
                <a href="mostrarVentas.html" class="btn btn-danger">Ventas</a>
            </div>

            <div class="card">
                <div class="card-body">
                    <form method="post" name="form_new_cliente_venta" id="form_new_cliente_venta">
                        <input type="hidden" name="action" value="addCliente">
                        <input type="hidden" id="idcliente" value="1" name="idcliente" required>
                        <div class="row">
                            <div class="col-lg-4">
                                <div class="form-group">
                                    <label>Dni</label>
                                    <input type="number" autofocus name="dni_cliente" id="dni_cliente" class="form-control" onblur="encontrarCliente()" maxlength="14">
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="form-group">
                                    <label>Nombre</label>
                                    <input type="text" name="nom_cliente" id="nom_cliente" class="form-control" disabled required>
                                </div>
                            </div>
                            
                            <div id="div_registro_cliente" style="display: none;">
                                <button type="submit" class="btn btn-primary">Guardar</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <br>
            <h4 class="text-center">Datos de Venta</h4>
            <div class="row">
              <div class="col-lg-6">
                  <div class="form-group">
                      <label><i class="fas fa-user"></i> VENDEDOR</label>
                      <p style="font-size: 16px; text-transform: uppercase; color: blue;">Usuario Actual</p>
                  </div>
              </div>
              <div class="col-lg-6" style="padding-left: 350px;">
                  <div class="form-group">
                      <label>Fecha de Hoy</label>
                      <p id="fecha" style="font-size: 16px; text-transform: uppercase;"></p>
                  </div>
          </div>
           </div>
           <div class="table-responsive">
               <table class="table table-hover" id="tabla">
                   <thead class="thead-dark">
                       <tr>
                           <th width="100px">Código</th>
                           <th>Descripción</th>
                           <!-- <th>Stock</th>  -->
                           <th width="100px">Cantidad</th>
                           <th class="textright">Precio</th>
                           <th class="textright">Precio Total</th>
                           <th>Acciones</th>
                       </tr>
                       <tr>
                        <td><input type="number" name="codProducto" id="codProducto" oninput="anadirProducto()"></td>
                        <td id="descripcionProd">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-</td>
                        <td><input type="text" style="width: 50px" name="cantidad" id="cantidad" oninput="calcularTotalDetalle()" value="0" min="1" disabled></td>
                        <td id="PrecioVenta" oninput="calcularTotalDetalle()">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-</td>
                        <td id="totalDetalle" class="txtright">0.00</td>
                        <td><button href="#" id="agregarProducto" class="btn btn-primary" onclick="agregarDetalleCompra()" disabled>Agregar</button></td>
                   </tr>
                       <tr>
                           <th>Código</th>
                           <th colspan="">Descripción</th>
                           <!-- <th>Stock</th>  -->
                           <th>Cantidad</th>
                           <th class="textright">Precio</th>
                           <th class="textright">Precio Total</th>
                           <th>Acciones</th>
                       </tr>
                   </thead>
                   <tbody id="detalleVenta">
                       <!-- Contenido ajax -->

                   </tbody>

                   <tfoot id="detalle_totales">
                    <th>Total</th>
                    <td></td>
                    <td></td>
                    <td id="PrecioVenta">Lps.</td>
                    <td id="totalFinal"></td>
                    <td><button class="btn btn-primary" id="btnGuardarCompra" onclick="guardarCompra()" disabled><i class="fas fa-save" style="padding-right: 3px;" ></i>Guardar Venta</button></td>
                    <!-- Contenido ajax -->
                </tfoot>
               </table>

           </div>
          </div>
       </div>
   </div>
</div>

    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
      <i class="fas fa-angle-up"></i>
    </a>

    <!-- Logout Modal-->
    <div
      class="modal fade"
      id="logoutModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="exampleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">
              ¿Seguro que desea cerrar sesión?
            </h5>
            <button
              class="close"
              type="button"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">×</span>
            </button>
          </div>
          <div class="modal-body">
            Selecciona "Cerrar Sesión" si estas seguro.
          </div>
          <div class="modal-footer">
            <button
              class="btn btn-secondary"
              type="button"
              data-dismiss="modal"
            >
              Cancelar
            </button>
            <a class="btn btn-primary" href="../../index.html">Cerrar Sesión</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap core JavaScript-->
    <script src="../../vendor/jquery/jquery.min.js"></script>
    <script src="../../vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="../../vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="../../js/sb-admin-2.min.js"></script>

    <!-- Page level plugins -->
    <script src="../../vendor/chart.js/Chart.min.js"></script>
  </body>
</html>

<script>
    
    var detalles=[];
    var fecha = new Date();
    document.getElementById("fecha").innerHTML = fecha.toLocaleString();

  function encontrarCliente(){
    var id = document.getElementById("dni_cliente").value;
        fetch(`http://localhost/back-end/api/clientes/read_single.php?id=${id}`)
        .then(response=>response.json())
        .then(data =>{
            document.getElementById('nom_cliente').value = data.nombre;
        })
        .catch(err =>{
            alert('No se encontró ningun cliente con el DNI especificado.')
            document.getElementById('dni_cliente').value = ""
            document.getElementById('nom_cliente').value = "";
            document.getElementById('dni_cliente').focus()
        })
  }

  function anadirProducto(){
    var id = document.getElementById("codProducto").value;
    if(id == ""){
        document.getElementById('descripcionProd').innerHTML = "      -";
        document.getElementById('PrecioVenta').innerHTML = "      -";
        disable("agregarProducto");
        disable("cantidad");
        disable("precioVenta");
        return;
    }
    fetch(`http://localhost/back-end/api/productos/read_single.php?id=${id}`)
    .then(response=>response.json())
    .then(data =>{
        if(data.descripcion == null){
            document.getElementById('descripcionProd').innerHTML = "      -";
            return;
        }
        document.getElementById('descripcionProd').innerHTML = data.descripcion;
        document.getElementById('PrecioVenta').innerHTML = data.precioVenta;
        enable("cantidad");
    }) 
  }

  function calcularTotal(){
    var total = 0;
    var table = document.getElementById("tabla");
    var tbodyRowCount = table.tBodies[0].rows.length;
    if(tbodyRowCount > 0){
        enable("btnGuardarCompra");
    }else{
        document.getElementById("totalFinal").innerText = "";
        disable("btnGuardarCompra");
    }
    for(var i = 0; i < detalles.length; i++){
        var totalDetalle = detalles[i].precioVenta * detalles[i].cantidad;
        total = totalDetalle + total;
    }
    document.getElementById("totalFinal").innerText = total;
 }

 function calcularTotalDetalle(){
    var cantidad = document.getElementById("cantidad").value;
    var precio = document.getElementById("PrecioVenta").innerText;
    var total = cantidad * precio;
    document.getElementById("totalDetalle").innerHTML = total;
    if(total > 0.00){
        enable("agregarProducto");
    }else{
        disable("agregarProducto");
    }
  }

 var rowCount = 1;
 function agregarDetalleCompra(){
        var codigoProd = document.getElementById("codProducto").value;
        var descripcion = document.getElementById("descripcionProd").innerText;
        var cantidad = document.getElementById("cantidad").value;
        var precio = document.getElementById("PrecioVenta").innerText;
        var total = document.getElementById("totalDetalle").innerText;
        html = document.getElementById("detalleVenta").innerHTML;
     let elemento = {
         idProducto: +codigoProd,
         cantidad: +cantidad,
         precioVenta: +precio
     }
     detalles.push(elemento);
		html += "<tr id=r"+rowCount+"><td id="+rowCount+">"+codigoProd+"</td>";
		html += "<td>"+descripcion+"</td>";
		html += "<td>"+cantidad+"</td>";
		html += "<td>"+precio+"</td>";
		html += "<td id=t"+rowCount+">"+total+"</td> ";
		html += `<td><button class="btn btn-danger" onclick="quitarDetalle(`+rowCount+`)">-</button></td></tr>`;
		document.getElementById('detalleVenta').innerHTML = html;
        reiniciarCamposCompra();
        calcularTotal();
        rowCount++;
 }

 function quitarDetalle(rowId){
    var idProducto = document.getElementById(rowId).innerHTML;
    for(var i = 0 ; i < detalles.length ; i++){
        if(detalles[i].idProducto == idProducto){
            detalles.splice(i,1);
        }
    }
    document.getElementById("r"+rowId).remove();
    calcularTotal();
 }

 function reiniciarCamposCompra(){
    document.getElementById('cantidad').value = "0";
    document.getElementById('PrecioVenta').innerText = "0.00";
    document.getElementById('totalDetalle').innerText = "0.00";
    document.getElementById('codProducto').value = "";
 }

 function guardarCompra(){
  var idClien = document.getElementById("dni_cliente").value;
  console.log(detalles)
  let datos = {
    idCliente: idClien,
    detalleVenta:detalles
  }
  let opciones = {
    method:"POST",
    headers:{"Authorization":`${localStorage.getItem('token')}`},
    body: JSON.stringify(datos)
  }

  fetch("http://localhost/back-end/api/ventas/create.php", opciones)
  .then(response=>response.json())
  .then(data=>{ 
    if (data.code === 0){
        alert("Venta registrada.");
        document.location.reload(true);
      }else{
        alert(data.message)
      }         
  })
  form_new_cliente_venta.reset();
  }
  
function disable(name)
  { document.getElementById(""+name+"").disabled = true; } 
function enable(name) 
 { document.getElementById(""+name+"").disabled = false; }
 
</script>